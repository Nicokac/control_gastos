# =============================================================================
# PYTEST CONFIGURATION
# =============================================================================

[tool.pytest.ini_options]
DJANGO_SETTINGS_MODULE = "config.settings.dev"
testpaths = ["apps"]

python_files = ["tests.py", "test_*.py", "*_tests.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]

addopts = [
  "-v",
  "--tb=short",
  "--strict-markers",
  "--reuse-db",
  "--nomigrations",

  # coverage
  "--cov=apps",
  "--cov-config=pyproject.toml",
  "--cov-report=term-missing:skip-covered",
  "--cov-report=html",
  "--cov-report=xml",
  "--cov-fail-under=80",
]

filterwarnings = [
  "ignore::DeprecationWarning",
  "ignore::PendingDeprecationWarning",
]

markers = [
  "slow: marks tests as slow (deselect with '-m \"not slow\"')",
  "integration: marks tests as integration tests",
  "unit: marks tests as unit tests",
]

# =============================================================================
# COVERAGE CONFIGURATION
# =============================================================================

[tool.coverage.run]
# Medir cobertura de ramas (if/else)
branch = true

# Directorio fuente
source = ["apps"]

# Archivos a excluir de la medición
omit = [
  "*/migrations/*",
  "*/tests/*",
  "*/__pycache__/*",
  "*/management/commands/*", # Comandos CLI
  "*/admin.py",
  "conftest.py",
  "*/conftest.py", 
  "apps/core/export.py", # Feature no implementada
  "apps/core/views.py",       # Archivo mínimo
]

# Ejecutar en paralelo (opcional, para tests grandes)
parallel = false

[tool.coverage.report]
# Umbral mínimo de cobertura (falla si es menor)
fail_under = 80

# Excluir líneas específicas del reporte
exclude_lines = [
  # Patrones estándar
  "pragma: no cover",
  "def __repr__",
  "def __str__",

  # Debug
  "if self.debug:",
  "if settings.DEBUG",

  # Abstractos
  "raise AssertionError",
  "raise NotImplementedError",

  # Type checking
  "if TYPE_CHECKING:",
  "if typing.TYPE_CHECKING:",

  # Defensive programming
  "if __name__ == .__main__.:",
]

# Mostrar líneas faltantes en el reporte
show_missing = true

# Precisión decimal
precision = 2

# Ordenar por nombre de archivo
sort = "Name"

[tool.coverage.html]
# Directorio para reportes HTML
directory = "htmlcov"

# Título del reporte
title = "Control de Gastos - Coverage Report"

[tool.coverage.xml]
# Para integración con CI/CD
output = "coverage.xml"


# =============================================================================
# RUFF CONFIGURATION
# =============================================================================

[tool.ruff]
# Versión de Python objetivo
target-version = "py311"

# Longitud máxima de línea
line-length = 100

# Directorios a excluir
exclude = [
    ".git",
    ".venv",
    "venv",
    "__pycache__",
    "migrations",
    "staticfiles",
    "htmlcov",
    ".pytest_cache",
    "node_modules",
]

[tool.ruff.lint]
# Reglas a habilitar
select = [
    "E",      # pycodestyle errors
    "W",      # pycodestyle warnings
    "F",      # Pyflakes
    "I",      # isort (imports)
    "B",      # flake8-bugbear
    "C4",     # flake8-comprehensions
    "UP",     # pyupgrade
    "DJ",     # flake8-django
    "SIM",    # flake8-simplify
    "PTH",    # flake8-use-pathlib
]

# Reglas a ignorar
ignore = [
    "E501",   # line too long (manejado por formatter)
    "B008",   # function call in default argument (común en Django)
    "B905",   # zip without strict= (Python 3.10+)
    "SIM108", # ternary operator (a veces menos legible)
]

# Permitir autofix para todas las reglas habilitadas
fixable = ["ALL"]
unfixable = []

[tool.ruff.lint.per-file-ignores]
# Ignorar imports no usados en __init__.py
"__init__.py" = ["F401"]
# Ignorar reglas de Django en tests
"**/tests/**" = ["DJ001", "DJ006", "DJ007"]
# Ignorar en conftest
"conftest.py" = ["F401", "E501"]
# Ignorar en settings
"**/settings/**" = ["F401", "F403", "F405"]

[tool.ruff.lint.isort]
# Configuración de ordenamiento de imports
known-first-party = ["apps", "config"]
known-django = ["django"]
section-order = [
    "future",
    "standard-library", 
    "django",
    "third-party",
    "first-party",
    "local-folder",
]

[tool.ruff.lint.flake8-django]
# Reglas específicas de Django (opcional)

[tool.ruff.format]
# Estilo de comillas
quote-style = "double"

# Estilo de indentación
indent-style = "space"

# Salto de línea
line-ending = "auto"

# Formatear docstrings
docstring-code-format = true