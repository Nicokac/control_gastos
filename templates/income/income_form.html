{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Editar{% else %}Nuevo{% endif %} Ingreso - Control de Gastos{% endblock %}


{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="mb-4">
                <a href="{% url 'income:list' %}" class="text-muted text-decoration-none">
                    <i class="bi bi-arrow-left me-1"></i>Volver a ingresos
                </a>
                <h1 class="h3 mt-2">
                    {% if is_edit %}
                    <i class="bi bi-pencil text-primary me-2"></i>Editar Ingreso
                    {% else %}
                    <i class="bi bi-plus-circle text-success me-2"></i>Nuevo Ingreso
                    {% endif %}
                </h1>
            </div>

            <form method="post" novalidate id="incomeForm">
                {% csrf_token %}

                <!-- Errores generales -->
                {% if form.non_field_errors %}
                <div class="alert alert-danger">
                    {% for error in form.non_field_errors %}
                    <p class="mb-0">{{ error }}</p>
                    {% endfor %}
                </div>
                {% endif %}

                <div class="card mb-4">
                    <div class="card-body">
                        <!-- MONTO (campo principal, grande) -->
                        <div class="mb-4">
                            <label class="form-label">Monto</label>
                            <div class="amount-input">
                                <div class="input-group">
                                    <span class="input-group-text fs-4">$</span>
                                    <input type="number"
                                           name="amount"
                                           id="id_amount"
                                           class="form-control form-control-lg text-end {% if form.amount.errors %}is-invalid{% endif %}"
                                           placeholder="0.00"
                                           step="0.01"
                                           min="0.01"
                                           value="{{ form.amount.value|default:'' }}"
                                           autocomplete="off"
                                           autofocus
                                           required>
                                    <select name="currency" id="id_currency" class="form-select" style="max-width: 100px;">
                                        <option value="ARS" {% if form.currency.value == 'ARS' %}selected{% endif %}>ARS</option>
                                        <option value="USD" {% if form.currency.value == 'USD' %}selected{% endif %}>USD</option>
                                    </select>
                                </div>
                                {% if form.amount.errors %}
                                <div class="invalid-feedback d-block">{{ form.amount.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Exchange rate (solo visible si USD) -->
                        <div class="mb-4 {% if form.currency.value != 'USD' %}d-none{% endif %}" id="exchangeRateField">
                            <label class="form-label">Cotización del dólar</label>
                            <div class="input-group" style="max-width: 250px;">
                                <span class="input-group-text">1 USD =</span>
                                <input type="number"
                                       name="exchange_rate"
                                       id="id_exchange_rate"
                                       class="form-control text-end {% if form.exchange_rate.errors %}is-invalid{% endif %}"
                                       placeholder="1000.00"
                                       step="0.01"
                                       min="0.01"
                                       value="{{ form.exchange_rate.value|default:'' }}"
                                       {% if form.currency.value != 'USD' %}disabled{% endif %}>
                                <span class="input-group-text">ARS</span>
                            </div>
                            {% if form.exchange_rate.errors %}
                            <div class="text-danger small mt-1">{{ form.exchange_rate.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- CATEGORÍA (botones visuales) -->
                        <div class="mb-4">
                            <label class="form-label">Categoría</label>
                            {% if form.category.errors %}
                            <div class="text-danger small mb-2">{{ form.category.errors.0 }}</div>
                            {% endif %}
                            <div class="category-grid">
                                {% for category in categories %}
                                <label class="category-btn">
                                    <input type="radio"
                                           name="category"
                                           value="{{ category.id }}"
                                           {% if form.category.value|stringformat:"s" == category.id|stringformat:"s" %}checked{% endif %}
                                           required>
                                    <div class="btn btn-outline-secondary">
                                        <i class="{{ category.icon|default:'bi-tag' }}"
                                           style="color: {{ category.color|default:'#6c757d' }}"></i>
                                        <small>{{ category.name }}</small>
                                    </div>
                                </label>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- FECHA y DESCRIPCIÓN -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label">Fecha</label>
                                <input type="date"
                                       name="date"
                                       id="id_date"
                                       class="form-control {% if form.date.errors %}is-invalid{% endif %}"
                                       value="{{ form.date.value|date:'Y-m-d' }}"
                                       required>
                                {% if form.date.errors %}
                                <div class="invalid-feedback">{{ form.date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-8">
                                <label class="form-label">Descripción</label>
                                <input type="text"
                                       name="description"
                                       id="id_description"
                                       class="form-control {% if form.description.errors %}is-invalid{% endif %}"
                                       placeholder="Ej: Sueldo Diciembre, Freelance, Alquiler..."
                                       value="{{ form.description.value|default:'' }}"
                                       required>
                                {% if form.description.errors %}
                                <div class="invalid-feedback">{{ form.description.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- CAMPOS OPCIONALES -->
                        <div class="mb-4">
                            <a class="text-decoration-none small"
                               data-bs-toggle="collapse"
                               href="#optionalFields"
                               role="button">
                                <i class="bi bi-chevron-down me-1"></i>Más opciones
                            </a>
                            <div class="collapse {% if form.is_recurring.value %}show{% endif %}"
                                 id="optionalFields">
                                <div class="mt-3 pt-3 border-top">
                                    <div class="form-check">
                                        <input type="checkbox"
                                               name="is_recurring"
                                               id="id_is_recurring"
                                               class="form-check-input"
                                               {% if form.is_recurring.value %}checked{% endif %}>
                                        <label class="form-check-label" for="id_is_recurring">
                                            <i class="bi bi-arrow-repeat me-1"></i>Es un ingreso recurrente
                                        </label>
                                        <small class="text-muted d-block">
                                            Marcá esta opción si es un ingreso que se repite mensualmente (ej: sueldo).
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- BOTÓN SUBMIT -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <a href="{% url 'income:list' %}" class="btn btn-outline-secondary">
                        Cancelar
                    </a>
                    <button type="submit" class="btn btn-success btn-lg px-5">
                        <i class="bi bi-check-lg me-2"></i>
                        {% if is_edit %}Guardar Cambios{% else %}Registrar Ingreso{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/income_form.js' %}"></script>
{% endblock %}
